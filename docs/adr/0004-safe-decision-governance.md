# ADR 0004 — Governance لآليات اتخاذ القرار الآمن

**التاريخ:** 2025-09-30

**الحالة:** مقترح

## السياق

مع إدخال وحدة اتخاذ القرار (`SafePolicyLearning` و `CausalBandit`)، يحتاج نظام Zebra إلى سياسة واضحة للتحكم في كيفية تقييم السياسات الجديدة، ونشرها، والتراجع عنها. الهدف هو ضمان أن القرارات التي يتخذها النظام لا تؤدي إلى تدهور الأداء أو عدم استقراره.

## القرار

1.  **النشر الآمن إلزامي (Mandatory Safe Evaluation):** لا تُنشر أي سياسة جديدة (سواء تم إنشاؤها بواسطة LLM أو أي آلية أخرى) تلقائيًا إلى الإنتاج إلا بعد اجتيازها لعملية التقييم الآمن (`evaluate_policy_safety`) بنجاح.

2.  **النشر التدريجي (Gradual Rollout):** حتى بعد اجتياز التقييم، يجب أن تخضع جميع السياسات الجديدة لعملية نشر تدريجي (`gradual_rollout`). لا يُسمح بالانتقال الفوري إلى 100% من حركة المرور.

3.  **تسجيل التدقيق (Audit Log):** يجب تسجيل جميع أنشطة اتخاذ القرار بشكل كامل. لكل سياسة يتم تقييمها أو نشرها، يجب تسجيل ما يلي على الأقل:
    *   `policy_id`: معرف فريد للسياسة.
    *   `policy_hash`: هاش لتعريف السياسة (e.g., hash of its parameters or code).
    *   `simulation_results`: ملخص نتائج المحاكاة (success_rate, worst_case, stability_report).
    *   `rollout_log`: سجل لمراحل النشر ونتائج المراقبة في كل مرحلة.
    *   `reviewer_id`: معرف الشخص الذي وافق على النشر (إذا كان مطلوبًا).
    *   `timestamp`: وقت كل حدث.

4.  **التحقق الرسمي (Formal Verification):** التحقق الرسمي باستخدام أدوات مثل Z3 هو خطوة اختيارية ومتقدمة. يمكن استخدامه كطبقة أمان إضافية للسياسات شديدة الخطورة، ولكنه ليس بديلاً عن المحاكاة والنشر التدريجي.

5.  **تحديثات Bandit المستندة إلى Counterfactual:** يمكن استخدام التقديرات المضادة للواقع (`counterfactual_fn`) لتسريع تعلم `CausalBandit`، ولكن يجب أن يتم ذلك بوزن منخفض (e.g., `weight < 0.2`) لتجنب الاعتماد المفرط على نماذج قد تكون غير دقيقة.

## المبررات

*   **تقليل المخاطر:** يضمن التقييم المسبق والنشر التدريجي اكتشاف المشكلات المحتملة قبل أن تؤثر على النظام بأكمله.
*   **الشفافية والمساءلة:** يوفر سجل التدقيق رؤية واضحة حول كيفية اتخاذ القرارات، مما يسهل تصحيح الأخطاء وتحليل الأداء.
*   **بناء الثقة:** يعزز النهج المحافظ والموجه بالبيانات الثقة في قدرة النظام على اتخاذ قرارات آمنة وفعالة.

## العواقب

*   **بطء نشر السياسات:** قد تستغرق عملية التقييم والنشر التدريجي وقتًا أطول من النشر الفوري.
*   **الحاجة إلى بنية تحتية للمحاكاة:** يتطلب التقييم الفعال وجود بيئة محاكاة (`SimulationEnvInterface`) تعكس البيئة الحقيقية بدقة.
*   **زيادة حجم السجلات:** سيؤدي تسجيل التدقيق الشامل إلى زيادة حجم البيانات المخزنة.