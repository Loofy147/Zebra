# Runbook: Circuit Breaker Tripped

## 1. التنبيه (Alert)

**التنبيه:** `CircuitBreakerTriggered`
**الخطورة:** حرجة (Critical)

## 2. الإجراءات الفورية (Immediate Actions)

1.  **تأكيد الإشعار:** قم بتأكيد استلام التنبيه في PagerDuty/Slack لمنع التصعيد غير الضروري.
2.  **التحقق من حالة قاطع الدائرة:**
    *   قم بالوصول إلى لوحة معلومات المراقبة (Grafana) وتحقق من لوحة "Circuit Breaker Status".
    *   تحقق من سبب فتح الدائرة (`breaker_name`, `reason`) والوقت الذي تم فيه ذلك.
3.  **التحقق من الإجراءات التلقائية:**
    *   تحقق من أن جميع التحسينات الآلية قد تم تعطيلها.
    *   تحقق من أن النظام قد عاد إلى آخر حالة آمنة معروفة.

## 3. التشخيص (Diagnosis)

1.  **فحص السجلات والمقاييس:**
    *   استرجع السجلات من الخدمات ذات الصلة (e.g., `zebra-observer`, `zebra-causal-worker`) في آخر 30 دقيقة.
    *   ابحث عن أي أخطاء أو تحذيرات غير عادية.
    *   افحص لوحات معلومات Grafana للبحث عن أي ارتفاعات غير طبيعية في معدل الأخطاء، أو زمن الاستجابة، أو استخدام الموارد.
2.  **مراجعة سجل التدقيق:**
    *   قم بالوصول إلى `AuditLog` وابحث عن آخر القرارات التي تم اتخاذها قبل فتح الدائرة.
    *   ابحث عن أي انتهاكات للسياسة تم تسجيلها.
3.  **تحديد السبب الجذري (Root Cause Analysis - RCA):**
    *   بناءً على البيانات التي تم جمعها، حدد السبب المحتمل للمشكلة.
    *   افتح تذكرة RCA جديدة في نظام التذاكر (e.g., Jira) واربطها بالتنبيه.

## 4. الإصلاح (Remediation)

1.  **تطبيق الإصلاح:** قم بتطبيق الإصلاح اللازم لمعالجة السبب الجذري. قد يشمل ذلك:
    *   نشر إصلاح للكود.
    *   التراجع عن تغيير في التكوين.
    *   إعادة تشغيل خدمة.
2.  **التحقق من الإصلاح:** تحقق من أن الإصلاح قد حل المشكلة في بيئة اختبار (staging environment) قبل المتابعة.

## 5. إعادة إغلاق الدائرة (Closing the Circuit)

1.  **بدء اختبار نصف مفتوح (Half-Open Test):**
    *   أعد تمكين التحسينات الآلية بشكل محدود (e.g., على جزء صغير من حركة المرور).
    *   راقب النظام عن كثب لمدة 15-30 دقيقة.
2.  **التحقق من صحة الاختبار:**
    *   إذا ظل النظام مستقرًا خلال فترة الاختبار، فاستعد لإغلاق الدائرة.
    *   إذا فشل الاختبار، فافتح الدائرة مرة أخرى وعد إلى خطوة التشخيص.
3.  **إغلاق الدائرة:**
    *   بعد نجاح اختبار نصف مفتوح، قم بإغلاق الدائرة يدويًا (بعد الحصول على موافقة إذا لزم الأمر).
    *   أعد تمكين جميع التحسينات الآلية تدريجيًا.

## 6. ما بعد الحادث (Post-Incident)

1.  **إكمال تقرير RCA:** قم بتوثيق السبب الجذري، والإصلاح، والتأثير، والجدول الزمني للحادث.
2.  **تحديد الإجراءات الوقائية:** حدد الإجراءات التي يمكن اتخاذها لمنع تكرار هذه المشكلة في المستقبل.
3.  **تحديث Runbook:** قم بتحديث هذا الـ runbook بأي معلومات جديدة تم تعلمها أثناء الحادث.